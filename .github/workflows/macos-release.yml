on:
  release:
    types: [created]
    # Sequence of patterns matched against refs/tags
    tags:
    - '[0-9]+.*' # Push events to matching 1.0, 2.0, 1.0.1-alpha

name: Upload Release Asset

jobs:
  release:
    name: Upload Release Asset
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v1
        with:
          submodules: recursive
      - name: Get current date
        id: DATE
        run: echo "name=$(date +'%Y%m%d')" >> $GITHUB_ENV
      - name: Get current version
        id: VERSION
        run: echo "name=$(GITHUB_REF#refs/tags/)" >> $GITHUB_ENV
      - name: Update project build date
        run: sed -i '' 's/20191017/'${DATE}'/g' Boxer.xcodeproj/project.pbxproj
      - name: Update project build version
        run: sed -i '' 's/2.0.0-alpha/'${VERSION}'/g' Boxer.xcodeproj/project.pbxproj
      - name: Update versions for Finder
        run: agvtool new-marketing-version ${VERSION}
      - name: Build the project
        run: xcodebuild -derivedDataPath ./build -workspace Boxer.xcworkspace -scheme "Boxer CI" -configuration "Release"
      - name: Package the release artefacts
        run: |
          hdiutil create -volname Boxer -srcfolder build/Build/Products/Release/Boxer.app -ov -format UDZO Boxer.dmg
      - name:  Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref }}
          file: ./Boxer.dmg
          asset_name: Boxer.dmg
          overwrite: true
